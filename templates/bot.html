<!DOCTYPE html> 
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Recommendations | E-learning</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
      html, body { 
        height: 100%; 
        margin: 0;
        padding: 0;
        overflow: hidden;
        
      }
      
      body { 
        min-height: 100vh; 
        display: flex;
        flex-direction: column;
        background-color: #a1e142;
      }
      .home-button {
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(234, 215, 4, 0.9);
        z-index: 1000;
      }
      
      .home-button:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 20px rgba(8, 173, 69, 0.918);
      }
      @keyframes fade-in {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      .animate-fade-in { animation: fade-in 0.5s; }
      
      /* Chat sidebar styling */
      .chat-sidebar {
        width: 250px;
        background-color: #a1e142;
        border-right: 1px solid #d6ded7;
        border-left:  1px solid #d6ded7;
        overflow-y: auto;
      }
      
      .home-button {
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(132, 194, 7, 0.868);
    }
    
    .home-button:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(8, 60, 230, 0.867);
    }

      .chat-item {
        transition: all 0.2s;
        position: relative;
      }
      
      .chat-item:hover {
        background-color: #9be228;
      }
      
      .chat-item.active {
        background-color: #0ecea1;
        border-left: 4px solid #4299e1;
      }
      
      /* Context menu styling */
      .context-menu {
        display: none;
        position: absolute;
        background: rgb(49, 96, 5);
        border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        padding: 5px 0;
        min-width: 150px;
      }
      
      .context-menu-item {
        padding: 8px 15px;
        cursor: pointer;
        font-size: 14px;
      }
      
      .context-menu-item:hover {
        background-color: #2d2de3;
      }
      
      .context-menu-delete {
        color: #eeece7;
      }
      
      .context-menu-delete:hover {
        background-color: #1e34dc;
      }
    

      
      /* Main container */
      .main-container {
        flex: 1;
        display: flex;
        overflow: hidden;
      }
      
      /* Chat area */
      .chat-area-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        
      }
      
      .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
      }
      
      /* Fixed input area */
      .input-container {
        flex-shrink: 0;
        padding: 1rem;
        background: linear-gradient(to top, rgba(6, 185, 176, 0.9), transparent);
        border-top: 1px solid #0ebeb5;
      }
      
      .video-results-anchor {
        scroll-margin-top: 20px;
      }
    </style>
  </head>

  <body bgcolor="#41dc1e">
    <div class="main-container h-screen">
      <div class="w-full max-w-7xl h-full bg-#41dc1e bg-opacity-90 rounded-xl shadow-lg overflow-hidden flex m-auto">
        <!-- Chat history sidebar -->
        <div class="chat-sidebar bg-white p-4 flex flex-col">
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-lg text-gray-700">Chat History</h3>
            
          </div>
          <a href="{{ url_for('new_chat') }}" class="mb-4 px-4 py-2 bg-gray-500 text-white rounded-lg text-center hover:bg-blue-600 transition">
            + New Chat
          </a>
          <div class="flex-1 overflow-y-auto" id="chat-history-container">
            {% for chat in all_chats %}
            <div class="chat-item-container relative">
              <a href="{{ url_for('chat', chat_id=chat.id) }}" 
                 class="block chat-item p-3 rounded-lg mb-2 {% if chat.id == active_chat_id %}active{% endif %}"
                 data-chat-id="{{ chat.id }}">
                <div class="text-sm font-medium text-gray-800 truncate">
                  {% if chat.history and chat.history[0].type == 'user' %}
                    {{ chat.history[0].text|truncate(20) }}
                  {% else %}
                    New Chat
                  {% endif %}
                </div>
                <div class="text-xs text-gray-500">{{ chat.created_at }}</div>
              </a>
            </div>
            {% endfor %}
          </div>
        </div>

        <!-- Main chat area -->
        <div class="chat-area-container">
          <div class="p-4 md:p-6 border-b border-gray-200">
            <h2 class="text-2xl font-bold text-blue-700 text-center">
              E-learning Video Bot
            </h2>
            <div class="text-center text-gray-600 mt-1">
              Ask about any learning topic or click a suggestion below!
            </div>

            <!-- Predefined topics -->
            <div class="flex flex-wrap justify-center gap-2 mt-4">
              {% for topic in topics %}
              <form method="POST" class="inline">
                <input type="hidden" name="topic" value="{{ topic }}" />
                <button
                  type="submit"
                  class="px-3 py-1 bg-gray-100 text-blue-700 rounded-full hover:bg-blue-200 transition text-sm font-medium shadow">
                  {{ topic }}
                </button>
              </form>
              {% endfor %}
            </div>
          </div>

          <!-- Messages area -->
          <div class="messages-container" id="chat-area">
            {% if chat_history %}
              {% for entry in chat_history %}
                {% if entry.type == 'bot' %}
                <div class="flex mb-4 animate-fade-in">
                  <div class="bg-white text-black rounded-lg px-4 py-2 max-w-xl ml-0 mr-auto shadow">
                    {{ entry.text }}
                  </div>
                </div>
                {% elif entry.type == 'user' %}
                <div class="flex justify-end mb-4 animate-fade-in">
                  <div class="bg-purple-500 text-white rounded-lg px-4 py-2 max-w-xl ml-auto mr-0 shadow">
                    {{ entry.text }}
                  </div>
                </div>
                {% elif entry.type == 'videos' %}
                <div class="w-full mb-6 animate-fade-in video-results-anchor" id="video-results-{{ loop.index }}">
                  <div class="text-lg font-semibold text-gray-700 mb-3 px-2">Results for "{{ entry.search_query }}"</div>
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 w-full px-2">
                    {% for video in entry.videos %}
                    <div class="bg-white rounded-lg shadow p-3 flex flex-col items-center hover:shadow-md transition w-full">
                      <img src="{{ video.thumbnail }}" alt="Thumbnail" class="rounded-lg w-full h-40 object-cover mb-3" />
                      <h3 class="text-base font-bold text-gray-800 mb-2 text-center leading-tight">
                        {{ video.title }}
                      </h3>
                      <a href="#" onclick="openVideo('{{ video.link }}')" 
                         class="mt-auto px-3 py-1 bg-purple-600 text-white rounded-lg text-sm font-semibold hover:bg-purple-700 transition">
                        Watch
                      </a>
                    </div>
                    {% endfor %}
                  </div>
                </div>
                {% endif %}
              {% endfor %}
            {% else %}
            <div class="flex mb-4 animate-fade-in">
              <div class="bg-white text-black rounded-lg px-4 py-2 max-w-xl ml-0 mr-auto shadow">
                Hi! What topic would you like video recommendations for?
              </div>
            </div>
            {% endif %}
          </div>

          <!-- Fixed Input at bottom -->
          <div class="input-container">
            <form method="POST"
              class="flex w-full max-w-4xl gap-2 items-center bg-green rounded-xl shadow-lg px-4 py-3 border border-gray-200 mx-auto">
              <input
                type="text"
                name="topic"
                placeholder="Type your topic..."
                class="flex-1 px-4 py-2 rounded-lg border border-gray-200 focus:ring-2 focus:ring-blue-400 focus:outline-none"
                autocomplete="off" />
              <button
                type="submit"
                class="px-5 py-2 bg-gray-600 text-white font-bold rounded-lg shadow hover:bg-blue-700 transition">
                Send
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

   
<a href="/" onclick="clearChatHistory();" class="home-button bg-gray-600 text-white px-6 py-2 rounded-full shadow-lg font-medium fixed top-4 right-4 hover:bg-blue-700 transition">
      <i class="fas fa-home mr-2"></i> Home
    </a>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
      <div class="context-menu-item context-menu-delete" onclick="deleteChat()">Delete Chat</div>
    </div>

    <!-- Video Modal -->
    <div id="videoModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50">
      <div class="bg-white rounded-lg shadow-lg relative flex flex-col" id="videoModalContent">
        <button onclick="closeVideo()" class="absolute -top-10 right-0 bg-red-600 text-white px-3 py-1 rounded-full z-10">X</button>
        <iframe id="videoFrame" class="w-full h-full rounded-lg"
                src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
      </div>
    </div>



    <script>
      // Store the currently selected chat ID for context menu operations
      let selectedChatId = null;
      
      // Auto-scroll chat to bottom when page loads and after new content is added
      function scrollToBottom() {
        const chatArea = document.getElementById("chat-area");
        if (chatArea) {
          chatArea.scrollTop = chatArea.scrollHeight;
        }
      }
      
     // Scroll to video results if needed
function scrollToResults() {
    // Find the latest video results section
    const videoSections = document.querySelectorAll('.video-results-anchor');
    if (videoSections.length > 0) {
      const lastVideoSection = videoSections[videoSections.length - 1];
      lastVideoSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
      scrollToBottom();
    }
}
      
      // Scroll on page load
      window.addEventListener('load', function() {
        // Small delay to ensure all content is rendered
        setTimeout(scrollToResults, 100);
      });
      
      // Video Modal Logic
      function openVideo(url) {
        let videoId = "";
        if (url.includes("v=")) videoId = url.split("v=")[1].split("&")[0];
        else if (url.includes("youtu.be/")) videoId = url.split("youtu.be/")[1].split("?")[0];
        else if (url.includes("/shorts/")) videoId = url.split("/shorts/")[1].split("?")[0];

        const embedUrl = "https://www.youtube.com/embed/" + videoId;
        document.getElementById("videoFrame").src = embedUrl;
        document.getElementById("videoModal").classList.remove("hidden");
        
        // Apply saved size settings
        applyVideoSizeSettings();
        
        // Prevent body scrolling when modal is open
        document.body.style.overflow = 'hidden';
      }

      function closeVideo() {
        document.getElementById("videoFrame").src = "";
        document.getElementById("videoModal").classList.add("hidden");
        
        // Re-enable body scrolling
        document.body.style.overflow = 'auto';
      }
      
      // Close modal when clicking outside content
      document.getElementById('videoModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeVideo();
        }
      });
      
      // Context menu functionality
      document.addEventListener('DOMContentLoaded', function() {
        const chatItems = document.querySelectorAll('.chat-item');
        const contextMenu = document.getElementById('contextMenu');
        
        chatItems.forEach(item => {
          item.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            selectedChatId = this.getAttribute('data-chat-id');
            
            // Position the context menu
            contextMenu.style.display = 'block';
            contextMenu.style.left = e.pageX + 'px';
            contextMenu.style.top = e.pageY + 'px';
          });
        });
        
        // Hide context menu when clicking elsewhere
        document.addEventListener('click', function() {
          contextMenu.style.display = 'none';
        });
        
        // Prevent context menu from closing when clicking on it
        contextMenu.addEventListener('click', function(e) {
          e.stopPropagation();
        });
      });
      
      // Delete chat function
      function deleteChat() {
        if (!selectedChatId) return;
        
        if (confirm('Are you sure you want to delete this chat?')) {
          // Send a request to delete the chat
          fetch('/delete-chat/' + selectedChatId, {
            method: 'POST',
          })
          .then(response => {
            if (response.ok) {
              // Remove the chat item from the UI
              const chatItem = document.querySelector(`.chat-item[data-chat-id="${selectedChatId}"]`);
              if (chatItem) {
                chatItem.closest('.chat-item-container').remove();
              }
              
              // If we're currently viewing the deleted chat, redirect to a new chat
              const currentPath = window.location.pathname;
              if (currentPath.includes(selectedChatId)) {
                window.location.href = '/bot/new';
              }
            } else {
              alert('Failed to delete chat');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete chat');
          });
        }
      }
      


      // Function to clear chat history when navigating to home
function clearChatHistory() {
  fetch('/clear-chat-history', {
    method: 'POST',
  }).catch(error => {
    console.error('Error clearing chat history:', error);
  });
}
    </script>
  </body>
</html>